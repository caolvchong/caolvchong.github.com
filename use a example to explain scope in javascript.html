<!DOCTYPE html>
<html>
<head>
    <title>javascript中的一个scope例子分析 - Tom's blog </title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <meta name="author" content="Tom"/>
    <link rel="shortcut icon" href="http://tomjoke.com/static/images/favicon.gif" />

    <link href="http://tomjoke.com/feeds/all.atom.xml" rel="alternate" title="Atom Rss" type="application/atom+xml" />

    <link href="http://tomjoke.com/static/themes/default/css/base.css" rel="stylesheet"/>

<link rel="stylesheet" href="http://tomjoke.com/static/themes/default/css/article.css"/>

    <!--[if lt IE 9]>
    <script src="http://tomjoke.com/static/js/html5shiv.js"></script>
    <script src="http://tomjoke.com/static/js/css3-mediaqueries.js"></script>
    <![endif]-->
    <script src="http://tomjoke.com/static/js/seajs/sea.js?_v=0.0.1"></script>
    <script src="http://tomjoke.com/static/js/config.js?_v=0.0.1"></script>
</head>
<body>

<header>
    <div class="logo"><a href="/" title="Tom's blog">Tom</a></div>
    <nav>
        <ul>
            <li><a href="/" title="首页" class=""><i class="fa fa-home fa-fw"></i>首页</a></li>
            <li><a href="http://tomjoke.com/archives.html" title="归档" class=""><i class="fa fa-archive fa-fw"></i>归档</a></li>
            <li><a href="http://tomjoke.com/about.html" title="关于" class=""><i class="fa fa-user-md fa-fw"></i>关于</a></li>
        </ul>
    </nav>
</header>

<div class="main">
    <aside class="left">
        <section class="introduce">
            <img src="http://tomjoke.com/static/images/avatar.jpg" alt="头像"/>

            <div class="nick"><span>Tom</span></div>
            <p>小时候理想是成为生物学家、作家、足球运动员，现在是一名前端工程师。</p>
            <address>
                <details open="open">
                    <summary>联系方式</summary>
                    <ul>
                        <li><i class="fa fa-envelope"></i> caolvchong[at]gmail.com</li>
                        <li><i class="fa fa-github"></i> <a href="https://github.com/caolvchong" title="草履虫的github">github.com/caolvchong</a></li>
                        <li><i class="fa fa-twitter"></i> <a href="https://twitter.com/caolvchong" title="草履虫的twitter">twitter.com/caolvchong</a></li>
                        <li><i class="fa fa-weibo"></i> <a href="http://ecma.weibo.com" title="草履虫的微博">ecma.weibo.com</a></li>
                        <li><i class="fa fa-home"></i> <a href="http://caolvchong.github.com" title="Tom's blog">caolvchong.github.com</a></li>
                    </ul>
                </details>
            </address>
        </section>
    </aside>

    <div class="center">
<article>
    <div class="article">
        <h1 class="head-title title"><i class="fa fa-pagelines"></i> <a href="http://tomjoke.com/use a example to explain scope in javascript.html">javascript中的一个scope例子分析</a></h1>
        <div class="article-info">
            <time><i class="fa fa-calendar"></i> 2009-04-11</time>
            <span class="article-tags"><i class="fa fa-tags"></i> <a href="tag/javascript.html">Javascript</a></span>
        </div>
        <div class="article-content"><p>代码是这样的（在运行代码前写出控制台打印的内容）：</p>
<div class="codehilite"><pre><span class="kd">function</span> <span class="nx">closure</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">v1</span> <span class="o">=</span> <span class="s1">&#39;v1&#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">v2</span> <span class="o">=</span> <span class="s1">&#39;v2&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">add1</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">v1</span> <span class="o">+=</span> <span class="s1">&#39;-add1&#39;</span><span class="p">;</span>
        <span class="nx">v2</span> <span class="o">+=</span> <span class="s1">&#39;-add1&#39;</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">v1</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">v2</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">add2</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">v1</span> <span class="o">+=</span> <span class="s1">&#39;-add2&#39;</span><span class="p">;</span>
        <span class="nx">v2</span> <span class="o">+=</span> <span class="s1">&#39;-add2&#39;</span><span class="p">;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">v1</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">v2</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">add1</span><span class="p">();</span>
    <span class="nx">add2</span><span class="p">();</span>

<span class="p">};</span>

<span class="nx">closure</span> <span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">);</span>
<span class="k">new</span> <span class="nx">closure</span><span class="p">();</span>
</pre></div>


<p>下面开始分析过程：</p>
<p>执行closure()，其中的this将指向window，这点在规范（ECMA-262 5th）中提到：</p>
<blockquote>
<p>10.4.3 Entering Function Code
2.Else if thisArg is null or undefined, set the ThisBinding to the global object.</p>
</blockquote>
<p>浏览器中的global object为window，因此进入closure函数体后，window上将增加<code>v2变量</code>与<code>add2方法</code>，即<code>window.v2</code>与<code>window.add2</code>。<br />
注意的是window.add2是在closure内部声明的，它可以访问得到closure的私有变量。<br />
大致执行过程为：</p>
<ol>
<li>私有变量v1赋值为 'v1'</li>
<li>window.v2赋值为 'v2'</li>
<li>进入add1函数体：v1 = 'v1-add1'；v2当前作用域中没有找到，向上找到window.v2，处理为 window.v2 = 'v2-add1'。打印</li>
<li>进入add2函数体（同样add2在当前作用域中没有找到，向上找到window.add2）：v1 = 'v1-add1-add2'，window.v2 = 'v2-add1-add2'。打印</li>
</ol>
<p>因此输出结果为：</p>
<div class="codehilite"><pre>v1-add1
v2-add1
v1-add1-add2
v2-add1-add2
</pre></div>


<p>然后执行 new closure()，此时this将指向对象实例，大致执行过程为：</p>
<ol>
<li>私有变量v1赋值为 'v1'</li>
<li>成员变量v2赋值为 'v2'，即 this.v2 = 'v2'</li>
<li>进入add1函数体：v1 = 'v1-add1'；v2（注意不是this.v2）当前作用域中没有找到，向上找到window.v2（此时值为上次执行的结果'v2-add1-add2'），处理为 window.v2 = 'v2-add1-add2-add1'。打印</li>
<li>进入add2函数体（注意不是this.add2，add2在当前作用域中没有找到，向上找到window.add2）：<br />
   v1 = 'v1-add1-add2-add2'，这里的v1是上次closure()执行后的（值为 'v1-add1-add2'），因为window.add2上在那里声明的<br />
   v2 则继续访问到window.v2，处理为 window.v2 = 'v2-add1-add2-add1-add2'<br />
   打印</li>
</ol>
<p>因此输出结果为：</p>
<div class="codehilite"><pre>v1-add1
v2-add1-add2-add1
v1-add1-add2-add2
v2-add1-add2-add1-add2
</pre></div></div>

<blockquote class="article-copyright">
    <ul>
        <li>作者：<a href="http://tomjoke.com/about.html" title="Tom">Tom</a></li>
        <li>原文：<a href="use a example to explain scope in javascript.html" title="javascript中的一个scope例子分析">javascript中的一个scope例子分析</a></li>
        <li>本文允许任意转载，但必须以链接形式注明作者和原文出处，并给出本声明</li>
    </ul>
</blockquote>    </div>

    <div class="article-bar">
        <ul class="article-neighbors">
            <li class="prev">
                上一篇：
                <span>没有了</span>
            </li>

            <li class="prev">
                下一篇：
                <a href="http://tomjoke.com/why can not inherit like this.html" title="为什么不能这么继承">为什么不能这么继承</a>
            </li>
        </ul>
    </div>

</article>

<div class="ds-thread"></div>
<script>
    var duoshuoQuery = {short_name:"tomblog"};
    seajs.use('http://static.duoshuo.com/embed.js');
</script>    </div>


    <aside class="right">
<section class="projects">
    <h3><i class="fa fa-list"></i> 项目</h3>
    <ul>
        <li><a href="https://github.com/caolvchong/gazira" title="Gazira">Gazira</a></li>
        <li><a href="https://github.com/caolvchong/gazira-cli" title="Gazira-cli">Gazira-cli</a></li>
        <li><a href="https://github.com/caolvchong/tpl" title="tpl2js">tpl2js</a></li>
    </ul>
</section>
<section class="tags">
    <h3><i class="fa fa-tags"></i> 标签</h3>
    <ul>
        <li><a href="http://tomjoke.com/tag/javascript.html" title="javascript">javascript</a></li>
        <li><a href="http://tomjoke.com/tag/life.html" title="life">life</a></li>
        <li><a href="http://tomjoke.com/tag/ubuntu.html" title="ubuntu">ubuntu</a></li>
        <li><a href="http://tomjoke.com/tag/template.html" title="template">template</a></li>
    </ul>
</section>
<section class="links">
    <h3><i class="fa fa-link"></i> 链接</h3>
    <ul>
        <li><a href="http://seajs.org/docs/" title="SeaJs">SeaJs</a></li>
        <li><a href="http://getpelican.com/" title="Pelican">Pelican</a></li>
        <li><a href="http://aralejs.org/" title="Arale">Arale</a></li>
        <li><a href="http://momo.im/" title="momo">momo</a></li>
        <li><a href="http://doit.im/" title="Doit">Doit</a></li>
    </ul>
</section>        <section class="copyright">
            Copyright &copy; 2014 Tom's blog. All Rights Reserved.
        </section>
    </aside>

</div>

<script>seajs.use('dist/app/article/index.js');</script>
<script>
    seajs.use('http://hm.baidu.com/h.js?b2b69380aee7d3c9db345aa8eb2eb90c');
</script></body>
</html>