<!DOCTYPE html>
<html>
<head>
    <title>为什么不能这么继承 - Tom's blog </title>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <meta name="author" content="Tom"/>
    <link rel="shortcut icon" href="http://tomjoke.com/static/images/favicon.gif" />

    <link href="http://tomjoke.com/feeds/all.atom.xml" rel="alternate" title="Atom Rss" type="application/atom+xml" />

    <link href="http://tomjoke.com/static/themes/default/css/base.css" rel="stylesheet"/>

<link rel="stylesheet" href="http://tomjoke.com/static/themes/default/css/article.css"/>

    <!--[if lt IE 9]>
    <script src="http://tomjoke.com/static/js/html5shiv.js"></script>
    <script src="http://tomjoke.com/static/js/css3-mediaqueries.js"></script>
    <![endif]-->
    <script src="http://tomjoke.com/static/js/seajs/sea.js?_v=0.0.1"></script>
    <script src="http://tomjoke.com/static/js/config.js?_v=0.0.1"></script>
</head>
<body>

<header>
    <div class="logo"><a href="/" title="Tom's blog">Tom</a></div>
    <nav>
        <ul>
            <li><a href="/" title="首页" class=""><i class="fa fa-home fa-fw"></i>首页</a></li>
            <li><a href="http://tomjoke.com/archives.html" title="归档" class=""><i class="fa fa-archive fa-fw"></i>归档</a></li>
            <li><a href="http://tomjoke.com/about.html" title="关于" class=""><i class="fa fa-user-md fa-fw"></i>关于</a></li>
        </ul>
    </nav>
</header>

<div class="main">
    <aside class="left">
        <section class="introduce">
            <img src="http://tomjoke.com/static/images/avatar.jpg" alt="头像"/>

            <div class="nick"><span>Tom</span></div>
            <p>小时候理想是成为生物学家、作家、足球运动员，现在是一名前端工程师。</p>
            <address>
                <details open="open">
                    <summary>联系方式</summary>
                    <ul>
                        <li><i class="fa fa-envelope"></i> caolvchong[at]gmail.com</li>
                        <li><i class="fa fa-github"></i> <a href="https://github.com/caolvchong" title="草履虫的github">github.com/caolvchong</a></li>
                        <li><i class="fa fa-twitter"></i> <a href="https://twitter.com/caolvchong" title="草履虫的twitter">twitter.com/caolvchong</a></li>
                        <li><i class="fa fa-weibo"></i> <a href="http://ecma.weibo.com" title="草履虫的微博">ecma.weibo.com</a></li>
                        <li><i class="fa fa-home"></i> <a href="http://caolvchong.github.com" title="Tom's blog">caolvchong.github.com</a></li>
                    </ul>
                </details>
            </address>
        </section>
    </aside>

    <div class="center">
<article>
    <div class="article">
        <h1 class="head-title title"><i class="fa fa-pagelines"></i> <a href="http://tomjoke.com/why can not inherit like this.html">为什么不能这么继承</a></h1>
        <div class="article-info">
            <time><i class="fa fa-calendar"></i> 2012-06-08</time>
            <span class="article-tags"><i class="fa fa-tags"></i> <a href="tag/javascript.html">Javascript</a></span>
        </div>
        <nav class="article-nav">
            <div>目录</div>
            <div class="toc">
<ul>
<li><a href="#_1">传统原型继承方式</a></li>
<li><a href="#_2">一个封装的疑问</a></li>
<li><a href="#_3">原因分析</a></li>
<li><a href="#_4">实现需求的方案</a></li>
</ul>
</div>
        </nav>
        <div class="article-content">
<h2 id="_1">传统原型继承方式</h2>
<p>且看代码：</p>
<div class="codehilite"><pre><span class="cm">/**</span>
<span class="cm"> * 父类</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">P</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">P</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">]);</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * 子类</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">S</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">P</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">F</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
<span class="nx">F</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">P</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
<span class="nx">S</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">F</span><span class="p">();</span>
<span class="nx">S</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">S</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="nx">s</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'b'</span><span class="p">);</span> <span class="c1">// 2</span>
</pre></div>
<h2 id="_2">一个封装的疑问</h2>
<p>前一段一同事讨论问题时候，问到javascript继承用下面的方式为什么得不到预期：</p>
<div class="codehilite"><pre><span class="kd">var</span> <span class="nx">S</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">F</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
    <span class="nx">F</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">P</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
    <span class="nx">P</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
    <span class="nx">S</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">F</span><span class="p">();</span>
    <span class="nx">S</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">S</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
<p>他希望构造器和原型链可以放在一个地方继承，但是按上面的写法，下面的调用会有问题：</p>
<div class="codehilite"><pre><span class="kd">var</span> <span class="nx">s1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="nx">s1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'b'</span><span class="p">);</span> <span class="c1">// 报错</span>

<span class="kd">var</span> <span class="nx">s1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="nx">s1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'b'</span><span class="p">);</span> <span class="c1">// 2</span>
</pre></div>
<h2 id="_3">原因分析</h2>
<p>本质原因是new机制导致，ECMA-262 5th 规范：</p>
<blockquote>
<p>13.2.2 [[Construct]]<br/>
When the [[Construct]] property for a Function object F is called, the following steps are taken:<br/>
1.Create a new native ECMAScript object.<br/>
2.Set the [[Class]] property of Result(1) to "Object".<br/>
3.Get the value of the prototype property of the F.<br/>
4.If Result(3) is an object, set the [[Prototype]] property of Result(1) to Result(3).<br/>
5.If Result(3) is not an object, set the [[Prototype]] property of Result(1) to the original Object prototype object as described in 15.2.3.1.<br/>
6.Invoke the [[Call]] property of F, providing Result(1) as the this value and providing the argument list passed into [[Construct]] as the argument values.<br/>
7.If Type(Result(6)) is Object then return Result(6).<br/>
8.Return Result(1).  </p>
</blockquote>
<p>第一次执行 new S(1, 2, 3) 在规范中的相关过程描述为：</p>
<ol>
<li>obj = new Object()</li>
<li>obj[[Prototype]] = S.prototype，可以看的出来S.prototype不存在，规范则将其指向 new Object()</li>
<li>S.call(obj, 1, 2, 3)，将obj作为this执行S函数，此时将会执行到 S.prototype = new F()，为第二次new准备了原型链</li>
<li>返回obj，因此obj[[Prototype]]是个空的obj，没有get方法</li>
</ol>
<p>而第二次执行 new S(1, 2, 3)，由于第一次的 S.prototype = new F() 的赋值，obj[[Prototype]]将等于P.prototype
因此第二次具备了get方法</p>
<h2 id="_4">实现需求的方案</h2>
<p>上述需求是想让 new S的同时，让对象从父对象P上得到原型链。new的原型继承无法做到，可以通过原型拷贝的方式实现</p>
<div class="codehilite"><pre><span class="kd">var</span> <span class="nx">S</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">method</span> <span class="k">in</span> <span class="nx">P</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 原型链拷贝</span>
        <span class="nx">S</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="nx">P</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">method</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="nx">P</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">s1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="nx">s1</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'b'</span><span class="p">);</span> <span class="c1">// 2</span>
</pre></div>
<p>当然，可以做一个简单的封装</p>
<div class="codehilite"><pre><span class="kd">var</span> <span class="nx">extend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">superClass</span><span class="p">,</span> <span class="nx">subClass</span><span class="p">,</span> <span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">method</span> <span class="k">in</span> <span class="nx">superClass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 原型链拷贝</span>
         <span class="nx">subClass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="nx">superClass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">method</span><span class="p">];</span>
     <span class="p">}</span>
     <span class="nx">superClass</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span> <span class="c1">// 构造器继承</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">S</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">extend</span><span class="p">(</span><span class="nx">P</span><span class="p">,</span> <span class="nx">S</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
<p>原型链拷贝方式还有个优势，多继承，这是原型链继承方式所不能做到的。</p></div>

<blockquote class="article-copyright">
    <ul>
        <li>作者：<a href="http://tomjoke.com/about.html" title="Tom">Tom</a></li>
        <li>原文：<a href="why can not inherit like this.html" title="为什么不能这么继承">为什么不能这么继承</a></li>
        <li>本文允许任意转载，但必须以链接形式注明作者和原文出处，并给出本声明</li>
    </ul>
</blockquote>    </div>

    <div class="article-bar">
        <ul class="article-neighbors">
            <li class="prev">
                上一篇：
                <a href="http://tomjoke.com/use a example to explain scope in javascript.html" title="javascript中的一个scope例子分析">javascript中的一个scope例子分析</a>
            </li>

            <li class="prev">
                下一篇：
                <a href="http://tomjoke.com/template in javascript.html" title="javascript中的模板">javascript中的模板</a>
            </li>
        </ul>
    </div>

</article>

<div class="ds-thread"></div>
<script>
    var duoshuoQuery = {short_name:"tomblog"};
    seajs.use('http://static.duoshuo.com/embed.js');
</script>    </div>


    <aside class="right">
        <section class="copyright">
            Copyright &copy; 2014 Tom's blog. All Rights Reserved.
        </section>
    </aside>

</div>

<script>seajs.use('dist/app/article/index.js');</script>
<script>
    seajs.use('http://hm.baidu.com/h.js?b2b69380aee7d3c9db345aa8eb2eb90c');
</script></body>
</html>